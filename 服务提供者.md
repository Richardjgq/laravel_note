# 服务提供者

### 知识点整理

```
1.简介
应用以及所有Laravel的核心服务都是通过服务提供者启动的.
启动,味着注册事物,包括注册服务容器绑定、事件监听器、中间件甚至路由.
服务提供者是应用配置的中心.
config/app.php文件中的providers数组,是应用所要加载的所有服务提供者类.
其中很多是延迟加载,真的用到它们的时候才会加载.
2.编写服务提供者
服务提供者都继承自Illuminate\Support\ServiceProvider类.
php artisan make:provider RiakServiceProvider 创建服务提供者类
大部分服务提供者都包含两个方法:register和boot
register方法:绑事物到服务容器
/**
 * 在容器中注册绑定.
 *
 * @return void
 */
public function register()
{
    $this->app->singleton(Connection::class, function ($app) {
        return new Connection(config('riak'));
    });
}
boot方法:服务提供者中注册视图 composer 
public function boot()
{
    view()->composer('view', function () {
        //
    });
}
boot方法的依赖注入
public function boot(ResponseFactory $response){
    $response->macro('caps', function ($value) {
        //
    });
}
3.注册服务提供者:追加数组
'providers' => [
    // 其它服务提供者
    App\Providers\ComposerServiceProvider::class,
]
4.延迟加载服务提供者
设置defer属性为true并定义一个provides方法
protected $defer = true;
public function provides()
{
    return [Connection::class];
}
```

服务提供者是Laravel应用启动的中心,自己的应用以及所有Laravel的核心服务都是通过服务提供者启动的.

但是,所谓的启动通常是指注册事务,包括注册服务容器绑定,事件监听器,中间件甚至路由.服务提供者是应用的配置的中心.

打开Laravel自带的config\/app.php文件,将会看到一个providers数组,这里就是应用所要加载的所有服务提供者类.其中很多是延迟加载的,也就是说不是每次请求都会被加载,只有真的用到它们的时候才会加载.

### 编写服务提供者

所有的服务提供者都继承自`Illuminate\Support\ServiceProvider`类.大部分服务提供者都包含两个方法:register和boot.在register方法中,唯一要做的事情就是绑定事物到服务容器,不要尝试在其中注册时间监听器,路由或者任何其他功能.

通过Artisan命令make:provider可以简单生成一个新的提供者:

```
php artisan make:provider RiakServiceProvider
```

**register方法**

```php
<?php
namespace App\Providers;
use Riak\Connection;
use Illuminate\Support\ServiceProvider;

class RiakServiceProvider extends ServiceProvider
{
    // 在容器中注册绑定
    public function register()
    {
        $this->app->singleton('Riak\Contracts\Connection', function($app){
            return new Connection(config('riak'));
        });
    }
}
```

该服务提供者只定义了一个register方法,并使用该方法在服务容器中定义了一个`Riak\Contracts\Connection`的实现.

**boot方法**

如果想要在服务提供者中注册视图composer,就要用到boot方法了.该方法在所有服务提供者被注册以后才会被调用,也就是说可以在其中访问框架已经注册的所有其他服务:

```php
<?php
namespace App\Providers;
use Illuminate\Support\ServiceProvider;

class EventServiceProvider extends ServiceProvider
{
    public function boot()
    {
        view()->composer('view', function(){
            //
        });
    }

    // 在容器中注册绑定
    public function register()
    {
        //
    }
}
```

**boot方法的依赖注入**

可以在boot方法中类型提示依赖,服务容器会自动注册你所需要的依赖:

```php
use Illuminate\Contracts\Routing\ResponseFactory;
public function boot(ResponseFactory $factory) 
{
    $factory->macro('caps', function ($value) {
        //
    });
}
```

### 注册服务提供者

所有服务提供者都是通过配置文件`config/app.php`中进行注册,该文件包含了一个列出所有服务提供者名字的`providers`数组,默认情况下,其中列出了所有核心服务提供者,这些服务提供者启动Laravel核心组件,比如邮件、队列、缓存等等.

要注册自己的服务提供者,将其追加到数组中即可:

```php
'providers' => [
    // 其它服务提供者
    App\Providers\ComposerServiceProvider::class,
],
```

### 延迟加载服务提供者



