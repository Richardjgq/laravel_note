# 数据库起步

### 简介

Laravel让连接多种数据库以及对数据库进行查询变得非常简单,不论使用原生SQL,还是查询构建器,还是Eloquent ORM.目前支持四种类型的数据库系统:

* MySQL
* Postgres
* SQLite
* SQL Server
* MongoDB - https:\/\/github.com\/jenssegers\/laravel-mongodb

**配置**
应用的数据库配置位于`config/database.php`.在文件中可以定义所有数据库连接,并指定哪个连接是默认连接.文件中提供了所有支持数据库系统的配置示例.

**SQLite配置**

使用 `touch database/database.sqlite` 命令创建好新的SQLite数据库之后,就可以使用数据库绝对路径配置环境变量指向这个新创建的数据库:

```php
DB_CONNECTION=sqlite
DB_DATABASE=/absolute/path/to/database.sqlite
```

**SQL Server配置**

Laravel开箱支持SQL Server,添加连接配置到配置文件`config/database.php`

```
'sqlsrv' => [
    'driver' => 'sqlsrv',
    'host' => env('DB_HOST', 'localhost'),
    'database' => env('DB_DATABASE', 'forge'),
    'username' => env('DB_USERNAME', 'forge'),
    'password' => env('DB_PASSWORD', ''),
    'charset' => 'utf8',
    'prefix' => '',
],
```

**读\/写连接**

有时候希望用一个数据库连接做查询,另一个数据库连接座插入,更新和删除,Laravel只需要简单的配置,不管是原生SQL,还是查询构建器,还是Eloquent ORM,合适的连接总是会被使用.

下面是配置读\/写连接的例子:

```
'mysql' => [
    'read' => [
        'host' => '192.168.1.1',
    ],
    'write' => [
        'host' => '192.168.1.2',
    ],
    'drive'     => 'mysql',
    'database'  => 'database',
    'username'  => 'root',
    'password'  => '',
    'charset'   => 'utf8',
    'collation' => 'utf8_unicode_ci',
    'prefix'    => '',
],
```

> 在read和write两个二维数组中的配置互相独立,其他部分例如drive等配置是共用的.

**多个数据库连接**

使用多个数据库连接的时候,可以通过DB门面上的connection方法访问每个连接.传递给`connection`方法的`name`对应配置文件`config/database.php`中列出的某个连接:

```
$users = DB::connection('foo')->select(...);
```

还可以使用连接实例上的getPdo方法访问底层原生的PDO实例:

```
$pdo = DB::connection()->getPdo();
```

### 运行原生SQL查询

配置好数据库连接后,就可以使用DB门面来运行查询.DB门面为每种查询提供了相应的方法:

* select
* update
* insert
* delete
* statement

**运行Select查询**
运行一个最基本的查询,可以使用DB门面的select方法

```
<?php
namespace App\Http\Controllers;
use DB;
use App\Http\Controllers\Controller;

class UserController extends Controller
{
    // 显示用户列表
    public function index()
    {
        $users = DB::select('select * from users where active = ?', [1]);
        return view('user.index', ['users' => $users]);
    }
}
```

传递给select方法的第一个参数是原生SQL,第二个参数是需要绑定的参数.通常是where条件的约束值.参数绑定可以避免SQL注入.

select方法以数组的形式返回结果集,数组中的每一个结果都是一个PHP StdClass对象,所有可以像下面这样访问结果值:

```
foreach ($users as $user) {
    echo $user->name;
}
```

**使用命名绑定**

除了使用`?`占位符来代表参数绑定外,还可以使用命名绑定来执行查询:

```
$results = DB::select('select * from users where id = :id', ['id' => 1]);
```

**运行插入语句**

使用`DB`门面的`insert`方法执行插入语句.和`select`一样,改方法将原生SQL语句作为第一个参数,将绑定作为第二个参数:

```
DB::insert('insert into users (id, name) value (?, ?)', [1, 'Bob']);
```

**运行更新语句**

`update`方法用于更新数据库中已存在的记录,该方法返回受更新语句影响的行数:

```
$affected = DB::update('update users set votes = 100 where name = ?', ['John']);
```

**运行删除语句**

delete方法用于删除数据库中已存在的记录,和update一样返回被删除的行数:

```
$deleted = DB::delete('delete from users');
```

**运行一个通用语句**

有些数据库语句不返回任何值,对于这种类型的操作,可以使用DB门面的statement方法:

```
DB::statement('drop table users');
```

**监听查询事件**

获取应用中每次SQL语句的执行,可以使用listen方法,对查询日志和调试非常有用,可以在服务提供者中注册查询监听器:

```
<?php
namespace App\Providers;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\ServiceProvider;

class AppServiceProvider extends ServiceProvider
{
    public function boot()
    {
        DB::listen(function ($query) {
            // $query->sql;
            // $query->bindings;
            // $query->time;
        });
    }

    public function register()
    {
        //
    }
}
```

### 数据库事务

在一个数据库事务中运行一连串操作,可以使用DB门面的transaction方法.如果事务闭包中抛出异常,事务将会自动回滚.执行成功了,事务将会自动提交.使用

