# HTTP中间件

HTTP中间件为过滤进入应用的HTTP请求提供了一套便利的机制.例如,Laravel内置了一个中间件来验证用户是否经过授权,如果用户没有经过授权,中间件会将用户重定向到登录页面,否则如果用户经过授权,中间件就会允许请求继续往前进入下一步操作.

当然,除了认证之外,中间件还可以被用来处理更多其它任务.比如:CORS中间件可以用于为离开站点的响应添加合适的头\(跨域\);日志中间件可以记录所有进入站点的请求.

Laravel框架自带了一些中间件,包括维护模式、认证、CSRF 保护中间件等等.所有的中间件都位于`app/Http/Middleware` 目录.

### 定义中间件

要创建一个新的中间件,可以通过Artisan命令`make:middleware`:

```
php artisan make:middleware CheckAge
```

这个命令会在`app/Http/Middleware`目录下创建一个新的中间件类CheckAge,在这个中间件中,只允许提供的age大于200的请求访问路由,否则将用户重定向到home:

```
<?php
namespace App\Http\Middleware;
use Closure;
class CheckAge
{
    // 返回请求过滤器
    public function handle($request, Closure $next)
    {
        if ($request->input('age') <= 100) {
            return redirect('home');
        }
        return $next($request);
    }
}
```

理解中间件的最好方式就是将中间件看做HTTP请求到达目标动作之前必须经过的"层",每一层都会检查请求并且可以完全决绝它.

**中间件之前\/之后**

一个中间件是请求前还是请求后执行取决于中间件本身.

以下中间件会在请求处理前执行一些任务:

```
<?php
namespace App\Http\Middleware;
use Closure;
class BeforeMiddleware
{
    public function handle($request, Closure $next)
    {
        // 执行动作
        return $next($request);
    }
}
```

在请求处理后执行其任务:

```
<?php
namespace App\Http\Middleware;
use Closure;
class AfterMiddleware
{
    public function handle($request, Closure $next)
    {
        $response = $next($request);
        // 执行动作
        return $response;
    }
}
```

### 注册中间件

**全局中间件**

如果想要中间件在每一个HTTP请求期间被执行,只需要将相应的中间件类设置到`app/Http/Kernel.php`的数组属性`$middleware`中即可.

**分配中间件到路由**

如果想要分配中间件到指定路由,首先应该在`app/Http/Kernel.php`文件中分配给该中间件一个简写的key.默认情况下,该类的$routeMiddleware属性包含了Laravel内置的入口中间件,添加自己的中间件,只需要将其追加到后面并为其分配一个key,例如:





### 中间件参数

### 可终止的中间件

