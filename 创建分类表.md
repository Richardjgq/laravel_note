# 文章分类

**创建分类表**

    CREATE TABLE `head_category` (
      `cateid` int(11) unsigned NOT NULL AUTO_INCREMENT,
      `catename` varchar(50) DEFAULT '',
      `catetitle` varchar(255) DEFAULT '',
      `catekeywords` varchar(255) DEFAULT '',
      `catedescription` varchar(255) DEFAULT NULL,
      `cateview` int(10) DEFAULT '0',
      `cateorder` tinyint(4) DEFAULT '0',
      `catepid` int(11) DEFAULT '0',
      PRIMARY KEY (`cateid`)
    ) ENGINE=MyISAM DEFAULT CHARSET=utf8;

也可以使用数据迁移的方式创建表.先手动添加一些内容.

**添加资源路由**

```
Route::resource('category', 'CategoryController');
```

**创建资源控制器**

```
php artisan make:controller Admin/CategoryController --resource
```

**创建模型**

```
php artisan make:model Http/Model/Category
```

**编辑控制器**

```
# 引入模板
public function index()
{
    # 获取分类树
    $categorys = (new Category)->tree();
    # 返回模板发送分类树变量,发送变量名默认用data
    return view('admin.category.index')->with('data', $categorys);
}
# 异步更新分类列表排序
public function changeOrder()
{
    $input = Input::all();
    $cate = Category::find($input['cateid']);
    $cate->cateorder = $input['cateorder'];
    $res = $cate->update();
    if ($res) {
        $data = [
            'status' => 0,
            'msg' => '分类排序更新成功!'
        ];
    } else {
        $data = [
            'status' => 1,
            'msg' => '分类排序更新失败,请稍后重试!'
        ];
    }
    return $data;
}
# 添加分类:这里引入了父级分类的基本内容
public function create()
{
    $data = Category::where('catepid',0)->get();
    return view('admin.category.add',compact('data'));
}
```

**编辑模型**

```
protected$table='category';
protected$primaryKey='cateid';
public$timestamps=false;
# 设置允许填充的字段
    # protected $fillable = ['catename','catepid'];
    # 排除不允许填充的字段
    protected $guarded = [];
# 获取分类数据方法
public function tree()
{
    $categorys = $this->orderBy('cateorder', 'asc')->get();
    $data = $this->getTree($categorys, 'catename','cateid', 'catepid');
    return $data;
}
# 整理分类数据
public function getTree($data, $field_name, $field_id, $field_pid, $pid = 0, $str = '┗ ')
{
    $tree = [];
    foreach ($data as $k => $v) {
        if ($v->$field_pid == $pid) {
            $tree[] = $data[$k];
            foreach ($data as $m => $n) {
                if ($n->$field_pid == $v->$field_id) {
                    $data[$m][$field_name] = $str.$data[$m][$field_name];
                    $tree[] = $data[$m];
                }
            }
        }
    }
    return $tree;
}
```

**编辑视图**

index列表页

```
@foreach($data as $v)
<tr>
    <td class="tc">
        <input type="text" onchange="changeOrder(this, {{ $v->cateid }})"  value="{{ $v->cateorder }}">
    </td>
    <td class="tc">{{ $v->cateid }}</td>
    <td>
        <a href="#">{{ $v->catename }}</a>
    </td>
    <td>{{ $v->catetitle }}</td>
    <td>{{ $v->cateview }}</td>
    <td>
        <a href="#">修改</a>
        <a href="#">删除</a>
    </td>
</tr>
@endforeach

# 引入layer弹出层,异步修改
<script>
    function changeOrder(obj, cateid)
    {
        var cateorder = $(obj).val();
        $.post(
            "{{ url('admin/cate/changeOrder') }}", {
                "_token":"{{ csrf_token() }}",
                "cateid":cateid,
                "cateorder":cateorder
            }, function(data){
                if (data.status == 0) {
                    layer.msg(data.msg, {icon: 6});
                } else {
                    layer.msg(data.msg, {icon: 5});
                }
        });
    }
</script>
```



