# 快速搭建博客系统

### 创建文章数据表及其模型

使用Artisan命令:

```
php artisan make:model --migration Post
```

上面的命令会做两件事:

* 在app目录下创建模型类App\Post;
* 创建用于创建posts表的迁移,文件位于database\/migrations目录下

编辑database\/migrations目录下刚生成的这个迁移文件内容如下:

```
<?php
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class CreatePostsTable extends Migration
{
    public function up()
    {
        Schema::create('posts', function (Blueprint $table) {
            $table->increments('id');
            $table->string('slug')->unique();
            $table->string('title');
            $table->text('content');
            $table->timestamps();
            $table->timestamps('published_at')->index();
        });
    }

    public function down()
    {
        Schema::drop('posts');
    }
}
```

在默认生成的迁移文件基础上新增四个额外的列:

* slug:将文章标题转化为URL的一部分,以利于SEO
* title:文章标题
* content:文章内容
* published\_at:文章正式发布时间

运行迁移命令:

```
php artisan migrate
```

最后修改生成的app\/Post.php文件:

```
<?php
namespace App;
use Illuminate\Database\Eloquent\Model;
class Post extends Model
{
    protected $dates = ['published_at'];
    public function setTitleAttribute($value)
    {
        $this->attributes['title'] = $value;
        if (!$this->exists) {
            $this->attributes['slug'] = str_slug($value);
        }
    }
}
```

### 使用测试数据填充文章表

这里用到了模型工厂功能

添加代码到database\/factories目录下的ModelFactory.php文件中:

```
$factory->define(App\Post::class, function ($faker) {
    return [
        'title' => $faker->sentence(mt_rand(3,10)),
        'content' => join("\n\n", $faker->paragraphs(mt_rand(3, 6))),
        'published_at' => $faker->dateTimeBetween('-1 month', '+3 days'),
    ];
});
```

然后修改database\/seeds目录下的DatabaseSeeder.php内容如下:

```
<?php
use Illuminate\Database\Seeder;
use Illuminate\Database\Eloquent\Model;
class DatabaseSeeder extends Seeder
{
    public function run()
    {
        Model::unguard();
        $this->call('PostTableSeeder');
    }
}

class PostTableSeeder extends Seeder
{
    public function run()
    {
        App\Post::truncate();
        factory(App\Post::class, 20)->create;
    }
}
```

**运行命令**

```
php artisan db:seed
```

### 创建配置文件

创建配置文件,比如标题,每页显示文章数等.

在config目录下创建一个新的配置文件blog.php:

```
<?php
return [
    'title' => 'My Blog',
    'posts_per_page' => 5
];
```

使用函数config\(\)访问配置很简单,例如:

```
config('blog.title'); # 返回title配置值
```

还可以修改config\/app.php的内容

### 创建路由和控制器

修改app\/Http\/routes.php文件:

```
<?php
get('/', function () {
    return redirect('/blog');
});
get('blog', 'BlogController@index');
get('blog/{slug}', 'BlogController@showPost');
```

路由规则解释:

访问\/时,重定向到\/blog,访问\/blog时,调用BlogController的index方法来处理业务逻辑并渲染页面.同理访问\/blog\/POST-TITLE时,调用BlogController的showPost方法,同时将POST-TITLE的值作为参数传递给showPost方法.

创建控制器:

```
php artisan make:controller BlogController --plain
```

> 注:--plan命令用于创建一个空的控制器而不是标准的RESTful风格控制器

生成的控制器在app\/Http\/Controllers目录下:

```
<?php
namespace App\Http\Controllers;
use App\Post;
use Carbon\Carbon;
class BlogController extends Controller
{
    public function index()
    {
        $posts = Post::where('published_at', '<=', Carbon::now())
                ->orderBy('published_at', 'desc')
                ->paginate(config('blog.posts_per_page'));

        return view('blog.index', compact('posts'));
    }

    public function showPost($slug)
    {
        $post = Post::whereSlug($slug)->firstOrFail();
        return view('blog.post')->withPost($post);
    }
}
```

在控制器中,使用Eloquent ORM与数据库进行交互,并使用辅助函数view\(\)渲染视图.

查看应用中所有的路由,可以使用下面的命令:

```
php artisan route:list
```

### 创建视图

创建两个视图

* 一个用于显示文章列表
* 一个用于显示文章详情

在resources\/views目录下创建一个新的目录blog.然后在该目录下创建一个新的视图文件index.blade.php.使用.blade.php后缀的目的是告知Laravel这个视图文件使用Blade模板.

```
<html>
    <head>
        <title>{{ config('blog.title') }}</title>
        <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">
    </head>
    <body>
        <div class="container">
            <h1>{{ config('blog.title') }}</h1>
            <h5>Page {{ $posts->currentPage() }} of {{ $posts->lastPage() }}</h5>
            <hr>
            <ul>
            @foreach ($posts as $post)
                <li>
                    <a href="/blog/{{ $post->slug }}">{{ $post->title }}</a>
                    <em>({{ $post->published_at }})</em>
                    <p>
                        {{ str_limit($post->content) }}
                    </p>
                </li>
            @endforeach
            </ul>
            <hr>
            {!! $posts->render() !!}
        </div>
    </body>
</html>
```

最后一步就是创建显示文章详情的视图.在resources\/views\/blog目录下新建视图文件post.blade.php,编辑其内容如下:

```
<html>
    <head>
        <title>{{ $post->title }}</title>
        <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">
    </head>
    <body>
        <div class="container">
            <h1>{{ $post->title }}</h1>
            <h5>{{ $post->published_at }}</h5>
            <hr>
                {!! nl2br(e($post->content)) !!}
            <hr>
            <button class="btn btn-primary" onclick="history.go(-1)">
                « Back
            </button>
        </div>
    </body>
</html>
```

