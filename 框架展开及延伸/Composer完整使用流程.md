# Composer

在PHPNOTE中已经有基本完整的记录,下面记录的是希望形成习惯的流程.

简单理解,Composer就是JS中的npm,Ruby中的Bundler,包依赖管理.

#### 安装

```php
php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
php -r "if (hash_file('SHA384', 'composer-setup.php') === '669656bab3166a7aff8a7506b8cb2d1c292f042046c5a994c43155c0be6190fa0355160742ab2e1c88d40d5be660b410') { echo 'Installer verified'; } else { echo 'Installer corrupt'; unlink('composer-setup.php'); } echo PHP_EOL;"
php composer-setup.php
php -r "unlink('composer-setup.php');"
```

#### 安装配置

```
# 安装路径
php composer-setup.php --install-dir=bin
# 安装文件名
php composer-setup.php --filename=composer
# 安装版本
php composer-setup.php --version=1.0.0-alpha8
```

> **TODO**  
> publickey - [https://composer.github.io/pubkeys.html](https://composer.github.io/pubkeys.html)
>
> 脚本安装 - [https://getcomposer.org/doc/faqs/how-to-install-composer-programmatically.md](https://getcomposer.org/doc/faqs/how-to-install-composer-programmatically.md)
>
> 最新测试版本使用参数 - composer self-update --preview --snapshot

#### Package引用和版本

编辑composer.json文件

```
{
  "require":{
    "mustache/mustache":"2.9.0"
  }
}
composer install
```

命令行引入

```
composer require mustache/mustache
```

版本更新

```
# 更新所有依赖
composer update
# 更新指定的包
composer upddate monolog/monolog
# 更新指定的多个包
composer update monolog/monolog symfony/dependency-injection
# 通过通配符匹配包
composer update monolog/monolog symfony/*
```

更新版本受版本约束的约束,一些其他常用命令

```
# 移除一个包及其依赖
composer remove monolog/monolog
```

进行包的搜索,可以在 [https://packagist.org/ ](https://packagist.org/中查找需要的包,也可以使用命令行搜索)中查找需要的包,也可以使用命令行搜索

```
composer search monolog
# 仅以名称匹配
composer search --only-name monolog
```

列出项目目前安装的包信息

```
# 列出所有已经安装的包
composer show
# 可以通过通配符进行筛选
composer show monolog/*
# 显示具体某个包的信息
composer show monolog/monolog
```

**版本约束**

确定的版本号

```
{
    "require": {
        "monolog/monolog": "1.19"
    }
}
# 或者
composer require monolog/monolog:1.19
composer require monolog/monolog=1.19
composer require monolog/monolog 1.19
```

指定版本号范围

```
操作符包括： > ， >= ， < ， <= ， != 
使用空格或逗号表示逻辑与,使用||表示逻辑或(与的优先级大于或)
```

> 连字符"-"类似于逻辑与,区别在于连字符右边的版本约束不是确定版本号时,会自动匹配通配符版本1.2会变成1.2.\*

通配符匹配最大版本

`1.0.*`相当于`>=1.0 <1.1`

**下一个重要版本操作符**

~号和^号

```
~ 操作符的用法： ~1.2 相当于 >=1.2 <2.0.0 ，而 ~1.2.3 相当于 >=1.2.3 <1.3.0
^ 操作符的用法： ^1.2.3 相当于 >=1.2.3 <2.0.0 (表示了当前版本到下一版本之间),再例如 ^0.3 会被当作 >=0.3.0 <0.4.0 对待
```

**版本稳定性**

如果没有显式的指定版本的稳定性，Composer会根据使用的操作符，默认在内部指定为`-dev`或者`-stable`

| 约束 | 内部约束 |
| :--- | :--- |
| 1.2.3 | =1.2.3.0-stable |
| &gt;1.2 | &gt;1.2.0.0-stable |
| &gt;=1.2 | &gt;=1.2.0.0-dev |
| &gt;=1.2-stable | &gt;=1.2.0.0-stable |
| &lt;1.3 | &lt;1.3.0.0-dev |
| &lt;=1.3 | &lt;=1.3.0.0-stable |
| 1 - 2 | &gt;=1.0.0.0-dev &lt;3.0.0.0-dev |
| ~1.3 | &gt;=1.3.0.0-dev &lt;2.0.0.0-dev |
| 1.4.\* | &gt;=1.4.0.0-dev &lt;1.5.0.0-dev |

指定只要稳定版本就可以在版本约束后面加上`-stable`

通过`minimum-stability`配置项定义了包在选择版本时对稳定性的选择的默认行为,默认为`-stable`

稳定性排序 : `dev`，`alpha`，`beta`，`RC`和`stable`

还可以通过稳定性标识在配置文件中直接写明

```
{
    "require": {
        "monolog/monolog": "1.0.*@beta",
        "acme/foo": "@dev"
    }
}
```

> 语义化版本约束 : [http://semver.org/lang/zh-CN/](http://semver.org/lang/zh-CN/)

#### 理解install和update

这两个命令关联了两个文件:composer.json和composer.lock文件.

composer.json中描述了需要安装的依赖包

composer.lock中描述了包运行的确定依赖包版本

执行composer install会首先根据composer.lock中确定的包的版本安装依赖,之后再去check另一个composer.json文件.

也就是说在composer.lock文件存在的情况下,install不会因为composer.json中声明的包依赖版本的变更而改变.

执行composer update刚好相反,该命令会根据composer.json文件中的包以来版本,更新composer.lock中的确定版本,再去安装更新后的包依赖.

#### Composer自动加载简单介绍

首先引入autoload.php文件,再任何一个新建文件中引入都可以

```
require 'vendor/autoload.php';
```

这样就可以加载vendor目录下我们用到的包了.

具体加载流程,我们首先查看vendor/autoload.php文件

```php
<?php

// autoload.php @generated by Composer

require_once __DIR__ . '/composer/autoload_real.php';

return ComposerAutoloaderInit44b63aad5a6cab5167b86d51ebcb28c2::getLoader();
```

其中我们可以看到,这个文件执行了`autoload_real.php`中的`getLoader()`这个方法

这个方法中最重要的就是下面的代码

```
if ($useStaticLoader) {
    require_once __DIR__ . '/autoload_static.php';

    call_user_func(\Composer\Autoload\ComposerStaticInit44b63aad5a6cab5167b86d51ebcb28c2::getInitializer($loader));
} else {
    $map = require __DIR__ . '/autoload_namespaces.php';
    foreach ($map as $namespace => $path) {
        $loader->set($namespace, $path);
    }

    $map = require __DIR__ . '/autoload_psr4.php';
    foreach ($map as $namespace => $path) {
        $loader->setPsr4($namespace, $path);
    }

    $classMap = require __DIR__ . '/autoload_classmap.php';
    if ($classMap) {
        $loader->addClassMap($classMap);
    }
}
```

这里面就是composer为我们提供的加载方式,比如我们常见的命名空间加载方式,psr4自动加载方式,classmap加载方式等等

> php规范 : www.php-fig.org

对于上面引入的文件,composer会根据包中的composer.json文件自动生成到对应的引入的这些自动加载文件当中,例如

```
$map = require __DIR__ . '/autoload_namespaces.php';
$map = require __DIR__ . '/autoload_psr4.php';
$classMap = require __DIR__ . '/autoload_classmap.php';
```

想要自动加载包中的文件,都是根据包的json文件的配置,生成到上面对应文件中,然后匹配自动加载的.

#### 如何寻找一个Package

通常情况下,我们都会再 [https://packagist.org/](#) 中寻找自己需要的包.

同样我们也可以使用命令行,前文中已经提到了

```
composer search monolog
# 仅以名称匹配
composer search --only-name monolog

# 在搜索到我们需要的相关包自后,但不确定其确切用途,还可以配合使用show展示详细信息(当然需要首先下载这个包)

# 列出所有已经安装的包
composer show
# 可以通过通配符进行筛选
composer show monolog/*
# 显示具体某个包的信息
composer show monolog/monolog
# 如果没后安装过这个包,可以添加参数查看其信息
composer show monolog/monolog -all
```

#### 使用Composer创建项目

常用的创建命令

```
composer create-project laravel/laravel
```

这样就可以快速的创建Laravel项目了,使用`php artisan serve`查看一下效果.

这个命令还可以添加一些参数

```
composer create-project slim/slim 文件夹名称 版本号
```

#### require-dev的使用方法和它的原理

这个配置选项的目的是为了方便在开发环境中使用一些类似debug的工具包等工具进行的配置.

它是不影响项目正常运行的,在生产环境中可以忽略安装.

```
{
    "require": {
        "mustache/mustache": "2.0.0"
    },
    "require-dev": {
    }
}
# 忽略require-dev的配置
composer install --no-dev
composer update --no-dev
```

#### Composer运行shell命令

在执行composer insatll或者composer update命令时可以添加一些shell脚本命令,json文件中以script为标识

```
# 例如在运行install命令之后,执行shell命令
{
    "require": {
        "mustache/mustache": "2.0.0"
    },
    "require-dev": {
        "monolog/monolog": "*"
    },
    "script": {
        "post-install-cmd": "echo \"Hello Wrold\""
    }
}
```

> TODO - 其他参数配置可以查看https://getcomposer.org/doc/articles/scripts.md官方文档





